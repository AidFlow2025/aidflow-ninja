<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Ninja â€” AidFlow Ninja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/main.css">
</head>

<body>

<main class="container">
  <h1>ðŸ¥· Registro Ninja</h1>

  <input
    id="user"
    placeholder="Usuario ninja"
    autocomplete="username"
  >

  <input
    id="pass"
    type="password"
    placeholder="ContraseÃ±a"
    autocomplete="new-password"
  >

  <label class="terminos-check">
    <input type="checkbox" id="terminos">
    Acepto los
    <a href="terminos.html" target="_blank">
      TÃ©rminos y Condiciones
    </a>
  </label>

  <button class="btn primary" onclick="registrar()">
    Entrar al Clan
  </button>

  <p id="msg" class="error"></p>
</main>

<script>
function registrar() {
  const user = document.getElementById("user").value.trim();
  const pass = document.getElementById("pass").value;
  const acepta = document.getElementById("terminos").checked;

  if (!user || !pass) {
    return msg("CompletÃ¡ usuario y contraseÃ±a");
  }

  if (!acepta) {
    return msg("DebÃ©s aceptar los tÃ©rminos");
  }

  // ðŸš« evitar duplicados
  if (
    localStorage.getItem("aidflow_user_" + user) ||
    localStorage.getItem("aidflow_pass_" + user)
  ) {
    return msg("Este usuario ya existe");
  }

  const params = new URLSearchParams(window.location.search);
  const referidoPor = params.get("ref");

  // ðŸ§  ESTRUCTURA BASE DEL USUARIO
  const userData = {
    user: user,
    nivel: 1,
    saldo: 0,
    ciclosCompletados: 0,
    pagoActivo: false,
    referidoPor: referidoPor || null,
    fechaAlta: new Date().toISOString()
  };

  // ======================
  // GUARDADO PRINCIPAL
  // ======================

  // objeto usuario
  localStorage.setItem(
    "aidflow_user_" + user,
    JSON.stringify(userData)
  );

  // compatibilidad con login actual
  localStorage.setItem("aidflow_pass_" + user, pass);
  localStorage.setItem("aidflow_user", user);
  localStorage.setItem("aidflow_auth", "true");

  // ======================
  // REFERIDOS
  // ======================
  if (referidoPor) {
    registrarReferido(referidoPor);
  }

  // ðŸ‘‰ redirigir a pago simulado
  window.location.href = "pago.html";
}

/* ======================
   REFERIDOS + DAO
====================== */

function registrarReferido(ref) {
  const refs =
    Number(localStorage.getItem("aidflow_refs_" + ref)) || 0;

  localStorage.setItem(
    "aidflow_refs_" + ref,
    refs + 1
  );

  procesarPagoInicial(ref);
}

function procesarPagoInicial(ref) {
  const pago = 10;

  const refData =
    JSON.parse(localStorage.getItem("aidflow_user_" + ref));

  if (!refData) return;

  let porcentaje = 0.4;
  if (refData.nivel === 2) porcentaje = 0.45;
  if (refData.nivel >= 3) porcentaje = 0.5;

  const refGanancia = pago * porcentaje;
  const daoGanancia = pago * 0.2;

  // sumar al referido
  refData.saldo += refGanancia;

  localStorage.setItem(
    "aidflow_user_" + ref,
    JSON.stringify(refData)
  );

  // sumar al DAO
  const dao =
    Number(localStorage.getItem("aidflow_dao")) || 0;

  localStorage.setItem(
    "aidflow_dao",
    dao + daoGanancia
  );
}

function msg(texto) {
  document.getElementById("msg").textContent = texto;
}
</script>

</body>
</html>
